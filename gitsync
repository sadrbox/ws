#!/bin/bash

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ –∏ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
BRANCH="main"
REMOTE="origin"

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
REPO_DIR="$(pwd)"
cd "$REPO_DIR" || { echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ $REPO_DIR"; exit 1; }

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."

# Pull —Å –æ—à–∏–±–∫–æ–π
git pull "$REMOTE" "$BRANCH" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull"; exit 1; }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
git status -s

# –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
if [ -n "$(git status --porcelain)" ]; then
    echo "‚úèÔ∏è –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∞–π–ª—ã > 50MB (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ GitHub)
    LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -c%s "{}" 2>/dev/null || echo 0) -gt 52428800 ]; then echo "{}"; fi')
    
    if [ -n "$LARGE_FILES" ]; then
        echo "‚ö†Ô∏è  –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã (>50MB): $LARGE_FILES"
        echo "   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Git LFS (git lfs track '*.zip') –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .gitignore."
        echo "   –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N)"
        read -r choice
        if [[ ! "$choice" =~ ^[Yy]$ ]]; then
            echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞. –î–æ–±–∞–≤—å—Ç–µ LFS –∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã."
            exit 1
        fi
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ .gitignore –∑–∞—Ä–∞–Ω–µ–µ!)
    git add .
    
    # –ö–æ–º–º–∏—Ç
    commit_msg="Auto commit: $(date +'%Y-%m-%d %H:%M:%S')"
    git commit -m "$commit_msg" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ"; exit 1; }
    
    # Push
    echo "üöÄ Push –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
    if git push "$REMOTE" "$BRANCH"; then
        echo "‚úÖ Push —É—Å–ø–µ—à–µ–Ω!"
    else
        echo "‚ùå Push –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã GitHub –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ LFS."
        exit 1
    fi
else
    echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π."
fi

# –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
git status -s
echo "üéâ –ì–æ—Ç–æ–≤–æ!"